Версионирование документов и поведение клиента
================================

Терминология:
-------------------------------

* версионные поля - поля с версией (сейчас это аудио и рисование)
* безверсионные поля - поля без версий (текст резолюции, дата исполнения, список исполнителей и тп)
* локальные ресурсы - файлы рисования и аудио.

Обязательные поля документа
-------------------------------

* **documentVersion** - строчная совокупная версия всех версионных и безверсионных полей
* **contentVersion** - строчная версия всех безверсионных полей
* **editable** - булевый флаг, показывающий, может документ редактироваться или нет
* **status** - строчный статус документа, одно из значений:
	* new - новый документ
	* draft - модифицированный документ
	* accepted - утвержденный документ
	* declined - отклоненный документ

За исключением поля **status**, содержимое этих полей контролируется только сервером.

Обязательные поля ресурсов
-------------------------------
* **version** - строчная версия ресурса, уникальная среди всех ресурсов всех документов

Заполнение этого поля контролируется сервером. При создании нового ресурса клиентом это поле при передаче серверу должно иметь значение **null**.

Поведение сервера
-------------------------------
При загрузке ресурса или документа сервер должен проверить передаваемую **documentVersion** головного документа и ресурса, и если версия совпадает с текущей, то принимать изменения и  отдавать в ответ новую **documentVersion** головного документа и ресурса.

Примеры реакции сервера
-------------------------------
1. Загрузка нового аудио комментария на сервер
клиент:

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":null
	}
}

+ содержимое самого файла

сервер с кодом 200:

{
	"parent":
	{
		"docId"":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"file version"
	}
}

2. Замещение существующего аудио

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"file version"
	}
}

+ содержимое самого файла

сервер с кодом 200:

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"new file version"
	}
}

3. Замещение существующего аудио, но при этом аудио уже было изменено на сервере

клиент:

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"new file version"
	}
}

сервер с кодом 500:

{
	"error":
	{
		"code:1000,
		"message":"conflict"
	}
}

4. Замещение существующего аудио, но при этом документ или контейнер файла был удален с сервера

клиент:

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"new file version"
	}
}

сервер с кодом 404:
произвольный
в этом случае клиент должен уничтожить локальные изменения в этом файле и перекачать документ с сервера по-новой (если документа нет, то он должен быть удален вместе со всеми ресурсами)

6. Удаление существующего аудио

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"file version"
	}
}

содержимое файла отсутствует

сервер с кодом 200:

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio": null
}

5. Замещение существующего аудио, но при этом документ был изменен на сервере

клиент:

{
	"parent":
	{
		"docId":"document id",
		"documentVersion:"document version"
	}
	"audio":
	{
		"version":"new file version"
	}
}

сервер с кодом 500:

{
	error:
	{
		code:1000,
		message:"conflict"
	}
}

в этом случае клиент должен уничтожить локальные изменения в этом файле и перекачать документ с сервера по-новой

Поведение клиента
-------------------------------

Во всех представлениях (view) документов показывается **documentVersion**

При изменении этой версии клиент должен скачать документ и проанализировать его содержимое по следующему алгоритму:

1. Если у документа поле **editable** установлено в **false**, то все локальные измения должны быть отменены и все измененные ресурсы долнжны быть перекачаны с сервера.
2. Пометить документ как непрочитанный
3. Изменить поле **status** на значение с сервера
4. Изменить локальную **documentVersion** на серверную
5. Если contentVersion не совпадает с локальной, то заменить локальное значение всех безверсионных полей, включая поле **status** и **contentVersion** на серверные значения
6. Проверить совпадение версий всех версионных полей и, если они не совпадают с серверными, перекачать локальные ресурсы по-новой или же удалить (в зависимости от значений этих полей)

Примеры реакции клиента
-------------------------------

1. Документ утвержден/отвергнут на сервере, и при этом на клиенте сделаны изменения

С сервера считывается документ, у которого **editable=false**, клиент отменяет все локальные изменения, выдает пользователю сообщение "Документ <заголовок> не может быть изменен" и перекачивает все локально измененые ресурсы.

2. Документ изменен на сервере и клиенте

	1. Пометить документ как непрочитанный
	2. Изменить поле **status** на значение с сервера
	3. Изменить локальную **documentVersion** на серверную
	4. Если contentVersion не совпадает с локальной, то заменить локальное значение всех безверсионных полей, включая поле **status** и **contentVersion** на серверные значения
	5. Проверить совпадение версий всех версионных полей и, если они не совпадают с серверными, перекачать локальные ресурсы по-новой или же удалить (в зависимости от значений этих полей)

3. Документ изменен на сервере и при утвержден/отвергнут на клиенте

	1. Пометить документ как непрочитанный
	2. Изменить поле **status** на значение с сервера (то есть при этом действие "принять" или "отклонить" отменяется)
	3. Изменить локальную **documentVersion** на серверную
	4. Если contentVersion не совпадает с локальной, то заменить локальное значение всех безверсионных полей, включая поле **status** и **contentVersion** на серверные значения
	5. Проверить совпадение версий всех версионных полей и, если они не совпадают с серверными, перекачать локальные ресурсы по-новой или же удалить (в зависимости от значений этих полей). при сравении учитывать уникальность версий в пределах всех версий всех документов.