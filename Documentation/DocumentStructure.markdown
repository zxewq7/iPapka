Структура документа
================================

Документы передаются в виде структур в формате валидного JSON.

Если какое-либо поле отсутствует в передаваемомо документе, то считается, что его значение равно **null** для строк, массивов и тп. Для булевых значений это **false**, для числовых **0**.

Под понятием файлового поля понимается обьект, состоящий из полей:

 * **id** - идентификатор поля
 * **version** - версия поля

Более подробное описание работы с такими полями приведено в описании механизма синхронизации.

Черновиком является документ со статусом **draft** или **new**

Поля, описанные как "обязательные" должны присутствовать в документе и иметь непустые значения для обьектов, строк и массивов. При отутсвии таких полей документ считается невалидным и не показывается.

Очереди документов
-------------------------------

Определены две очереди для получения:

* **необработанные документы** - документы со статусом **new** и **draft**.
* **обработанные документы** - документы со статусом **accepted** и **rejected**

Обе очереди должны иметь контент в формате стандартного вывода view в формате JSON в Lotus Domino версии 7.0.2 - 8.5.x и иметь обязетельную колонку **version**, соотвествующей **docVersion** документа

URL для необработанных документов: **protocol**://**hostName**/**databaseName**/documents/?ReadViewEntries&OutputFormat=json
URL для обработанных документов: **protocol**://**hostName**/**databaseName**/ProcessedRest/?ReadViewEntries&OutputFormat=json

где:

* **protocol** - протокол работы с сервером (http или https)
* **hostName** - имя хоста
* **databaseName** - название базы данных. Может быть id реплики или включать в себя путь к БД.

Описание общих полей документа
-------------------------------

**Пример документа**

<code>
	{
	"type": "resolution",
	"id": "C2BD986B24B1CB24C32577DD003D915A",
	"docVersion": "C32577DD:0045A59D",
	"contentVersion": "C32577DD:0045A59D",
	"modified": "20101116T195822,00+00",
	"created": "20101116T195822,00+00",
	"status":  "draft" ,
	"priority" : 0,
	"author": "Леонов О.В.",
	"editable": true
	}
</code>

* **type** - обязательное строковое значение типа документа. Возможные значения: 
	* **document** - документ на подпись
	* **resolution** - документ с резолюцией
* **id** - обязательный строковый идентификатор документа. Уникален среди всех документов системы.
* **docVersion** - обязательная строковая версия всех безверсионных и версионных полей документа.
* **contentVersion** - обязательная строковая версия всех безверсионных полей.
* **modified** - обязательная строковая дата последней модификации документа в формате **yyyyMMddTHHmmss,SS+TZ**
* **created** - обязательная строковая дата создания документа в формате **yyyyMMddTHHmmss,SS+TZ**
* **status** - обязательный строковый статус документа. Возможные значения:
	* **new** - новый документ.
	* **draft** - документ, в который вносились изменения. 
	* **accepted** - утвержденный документ.
	* **rejected** - возвращенный документ.
* **priority** - целый числовой приоритет документа. Возможные значения:
	* **0** - нормальный приоритет.
	* **1** - высший приоритет.
* **author** - обязательное строковое значение автора документа.
* **editable** - обязательное булевое поле признака возможности редактирования документа и всех связанных с ним обьектов


Документ проекта резолюции
-------------------------------

**Пример документа**

<code>
	{
	"type": "resolution",
	"id": "C2BD986B24B1CB24C32577DD003D915A",
	"docVersion": "C32577DD:0045A59D",
	"contentVersion": "C32577DD:0045A59D",
	"modified": "20101116T195822,00+00",
	"created": "20101116T195822,00+00",
	"status":  "draft" ,
	"priority" : 0,
	"author": "Леонов О.В.",
	"text": "Прошу исполнить в срок",
	"performers": ["Кулешева И.В.%Секретарь%ОУПО%CDF4157F9CA4D501C32573D8002FD1A1%C32573D1003D565A","Восьмёркин В.В.%Аналитик%УТП%308D45E2EE9BE59FC3257654004E2370%C32573D1003D565A"],
	"deadline": "20101013",
	"hasControl": true,
	"date": "20101116T195822,00+00",
	"parent": { 
		"author": "Арсеньев С.А.",
		"date": "20101116T195822,00+00",
		"text": "срочно исполнить",
		"performers": [
			"Симонов А.Ю.","Кравченко П.А.","Кулешева И.В.","Иванов Д.","Леонов О.В."
		],
		"deadline": "20100322"
	},
	"document": {
		"regNumber": "44"
		,"regDate": "20100319"
		,"corrs": [
			"Сибтяжмаш"
		]
		,"subject": "О продлении срока поставки"
		,"files": [ {"id": "585907375e42599300f55777baf16c8b","name": "03_поставка_материального_носителя_с_СМ(Д_2_реквизиты).tiff","pageCount": 7, "drawings": [{"parent":{"pageNum":0}, "id":"id", "version":"version"}]} ]
		,"links": [{"id":"1","type":"Последующие","info": "28 от 31.07.2009", "files": [{"id":"de85a92ed9f45ed797ca78d37aedffe6","name":"Документ.tif","pageCount":20},{"id":"ef4f6a7d2a80af94bd18114eb6e77c99","name":"Дополнения к ПЗ на доработку ПО СМ 3.tiff","pageCount":12}]}] 
	}
	"resources": { 
	                "drawing": [{"id":"id", "version":"version"}], 
	                "audio": [{"id":"id1","version":"version1"}, {"id":"id2","version2":"version2"}]
	        }
		}
</code>

**Описание полей**

 * **text** - строковый текст резолюции.
 * **performers** - массив строк иденитификаторов исполнителей. Идентификаторы должны быть подмножеством идентификаторов обьектов, передаваемых клиенты в виде адресной книги. Порядок следования элементов в массиве имеет значение.
 * **deadline** - строковая дата срока исполнения резолюции в формате **yyyyMMdd**
 * **hasControl** - булевое значение "на контроле"
 * **date** - строковая дата утверждения/отклонения резолюции в формате **yyyyMMddTHHmmss,SS+TZ**. В черновиках эта дата не определена.
 * **parent** - обьект вышестоящей резолюции, имеющий следующую структуру:
	* **author** - обязательное строковое значение автора резолюции
	* **date** - обязательная строковая дата вышестоящей резолюции в формате **yyyyMMddTHHmmss,SS+TZ**
	* **text** - обязательный текст вышестоящий резолюции
	* **performers** - массив строк исполнителей вышестоящей резолюции
	* **deadline** - строковая дата срока исполнения вышестоящей резолюции в формате **yyyyMMdd**
 * **document** - обязательный обьект со следующей структурой:
	* **regNumber** - строковый регистрационный номер резолюции
	* **regDate** - обязательная  дата срока регистрации резолюции в формате **yyyyMMdd**
	* **corrs** - массив строк корреспондентов
	* **subject** - обязательный заголовок резолюции
	* **files** - обязательный непустой массив вложений для резолюции со следующей структурой:
		* **id** - обязательный строковый идентификатор вложения. Уникален среди всех вложений данного документа.
		* **name** - обязательное строковое название вложения
		* **pageCount** - обязательное число страниц во вложении. Страницы нумеруются от 0 до (**pageCount** - 1). Каждая страница представляет собой графический файл в формате png.
		* **drawings** - массив файловых полей рисований к страницам  со следующей структурой:
			* **parent** - обязательный обьект со следующей структурой:
				* **pageNum** - обязательный числовой номер страницы
			* Прочие поля соотвествуют спецификации файловых полей
		* **links** - массив обьектов связанных документов, имеющих следующую структуру:
			* **id** - обязательный строковый идентификатор связанного документа. Уникален внутри своего обьекта.
			* **info** - обязательный строковый заголовок связанного документа
			* **type** - обязательный строковый тип связи
			* **files** - аналогичен полю **document.files** в резолюции
	* **resources** - обьект, имеющий два значения:
		* **drawing** - массив файловых полей рисунков к документу
		* **audio** - массив файловых полей аудио комментариев к документу

Проект документа на подпись
-------------------------------

<code>
	{
	"type": "document",
	"id": "77754C83D03A4A19C32577DC005D6736",
	"version": "C32577DD:0045A5A6",
	"modified": "20101116T154043,00+00",
	"created": "20101116T195822,00+00",
	"status":  "new" ,
	"priority" : 1,
	"author": "Леонов О.В.",
	"text": "",
	"date": "20101116T195822,00+00",
	"document": {
		"regNumber": ""
		,"corrs": [
			"Аэрофлот"
		]
		,"subject": "О подтверждение работоспособности системы"
		,"files": [ {"id": "fca32d528b7f695f0b8ff248482bd5b0","name": "Сопроводиловка_28092009.tiff","pageCount": 1} ]
		,"links": [{"id":"2","type":"В связи с","info": "21 от 27.04.2009", "files": [{"id":"3e2f670c233ec4f94a446302d9089d4c","name":"ГПБ.JPG","pageCount":1}]}] 
	}
	"resources": { 
	                "audio": [{"id":"id1","version":"version1"}, {"id":"id2","version2":"version2"}]
	        }
	
	}
</code>

* **text** - строковый комментарий.
* **date** - строковая дата утверждения/отклонения документа в формате **yyyyMMdd**. В черновиках эта дата не определена.
* **document** - обязательный обьект со следующей структурой:
	* **regNumber** - обязательный строковый регистрационный номер документа
	* **regDate** - обязательная  дата срока регистрации документа в формате **yyyyMMdd**
	* **corrs** - массив строк корреспондентов
	* **subject** - обязательный заголовок документа
	* **files** - обязательный непустой массив вложений для документа со структурой, аналогичной полю **document.files** в резолюции
	* **resources** - обьект со следующей структурой:
		* **audio** - массив файловых полей аудио комментариев к документу
	* **links** - аналогичной полю **document.links** в резолюции

Файловые ресурсы документов
-------------------------------

URL доступа к документу: 
**protocol**://**hostName**/**databaseName**/document/**docId**

URL доступа к рисованию к странице документа: 
**protocol**://**hostName**/**databaseName**/document/**docId**/file/**fileId**/page/**pageNum**/drawing

URL доступа к рисованию к странице связанного документа:
**protocol**://**hostName**/**databaseName**/document/**docId**/link/**linkId**/file/**fileId**/page/**pageNum**/drawing/**drawingId**

URL доступа к аудио комментария документа:
**protocol**://**hostName**/**databaseName**/document/**docId**/audio/**audioId**

где:

* **protocol** - протокол работы с сервером (http или https)
* **hostName** - имя хоста
* **databaseName** - название базы данных. Может быть id реплики или включать в себя путь к БД.
* **docId** - идентификатор документа
* **linkId** - идентификатор связанного документа
* **fileId** - идентификатор файла
* **pageNum** - номе страницы
* **drawingId** - идентификатор файлового поля рисования
* **audioId** - идентификатор файлового поля аудио

Сортировка документов на клиенте в очередях
-------------------------------

* в очереди **необработанные документы** документы должны группироваться по дате создания (поле **created**) по убыванию. Внутри каждой группы сортировка идет по убыванию важности (поле **priority**) и по убыванию времени создания.
* в очереди **обработанные документы** документы должны группироваться по дате обработки (поле **date**) по убыванию. Внутри каждой группы сортировка идет по убыванию времени обработки.

Даты при показе документов на клиенте
-------------------------------

В проекте резолюции и комментарии к документу на подпись показывается дата **date**.
В информации о документе показывается дата **document.regDate**.